var HashMap=function(){function t(){var o=[];return o=Array.apply(o,arguments)||o,o.__proto__=t.prototype,o.mapTable=function(t){return this.map(function(e){return e[t]})},o.indexOfKey=function(t,e){return this.mapTable(t).indexOf(e)},o.put=function(t,e){var n=e||this.length;this[n]=t},o.putRange=function(t,e){if(t&&t instanceof Array){var n,o=e&&"boolean"==typeof e?this.length:0,r=t.length;for(n=0;r>n;n++)this.put(t[n],o+n)}},o.query=function(n){var o=n&&"object"==typeof n?n:{},r=new t;return r.putRange(this.filter(function(t){return e(t,o)})),r},o.orderBy=function(t){var e,n=t&&"object"==typeof t?t:{},o=function(t,e){return"string"==typeof t?t.localeCompare(e):(t>e)-(e>t)},r=function(t,e){return"string"==typeof e?e.localeCompare(t):(e>t)-(t>e)};return this.sort(function(t,i){var a=0;for(e in n){if(t[e]!=i[e]){a="desc"===n[e]?r(t[e],i[e]):o(t[e],i[e]);break}a=0}return a}),this},o.groupBy=function(o,r,i){var a,c,f,s=new t,u=i&&"object"==typeof i?i:{},p=r.length,l={};return this.forEach(function(t){if(e(t,u)){for(c={},f=0;p>f;f++)c[r[f]]=t[r[f]];a=JSON.stringify(c),l[a]=l[a]||[],l[a].push(t)}}),s.putRange(Object.keys(l).map(function(t){return c=JSON.parse(t),n(l[t],o,c)})),s},o.compute=function(t){return n(this,t)},o}var e=function(t,e){var n,o,r,i=!0;for(n in e){if(!i)break;if("object"==typeof e[n]){r=t[n].toString();for(o in e[n]){switch(o){case"$gt":i=t[n]>e[n][o];break;case"$gte":i=t[n]>=e[n][o];break;case"$lt":i=t[n]<e[n][o];break;case"$lte":i=t[n]<=e[n][o];break;case"$start":i=0===r.lastIndexOf(e[n][o],0);break;case"$end":i=-1!==r.indexOf(e[n][o],r.length-e[n][o].length);break;case"$contain":i=r.indexOf(e[n][o])>-1;break;case"$in":i=e[n][o].indexOf(t[n])>-1;break;case"$custom":i=e[n][o].call(e[n][o],t);break;default:i=!1}if(!i)break}}else i=t[n]==e[n]}return i},n=function(t,e,n){var o,r,i,a=e&&e instanceof Array?e:[e],n=n||{};return a.forEach(function(e){for(o in e)break;switch(r=e[o],i=e.alias||r,o){case"$max":t.sort(function(t,e){return e[r]-t[r]}),n[i]=t[0][r];break;case"$min":t.sort(function(t,e){return t[r]-e[r]}),n[i]=t[0][r];break;case"$sum":n[i]=t.map(function(t){return t[r]}).reduce(function(t,e){return parseFloat(t)+parseFloat(e)},0);break;case"$avg":n[i]=t.map(function(t){return t[r]}).reduce(function(t,e){return parseFloat(t)+parseFloat(e)},0),n[i]/=t.length;break;case"$count":n[i]=t.length}}),n};return t.prototype=Object.create(Array.prototype),t.cloneObject=function(t){if("[object Array]"===Object.prototype.toString.call(t)){for(var e=[],n=0,o=t.length;o>n;n++)e[n]=arguments.callee(t[n]);return e}if(t&&!(t instanceof Date)&&"object"==typeof t){var n,e={};for(n in t)e[n]=arguments.callee(t[n]);return e}return t},t}(),DbProxies=function(){return{LOCALSTORAGE:0,SQLITE:1}}(),DbProxy=function(){function t(){}return t}(),LocalStorageProxy=function(){function t(){DbProxy.apply(this,arguments)}var e=function(t){var e=window.localStorage[t],n=new HashMap;return e&&n.putRange(JSON.parse(e)),n},n=function(t,e,n){window.localStorage[t]=JSON.stringify(e),"function"==typeof n&&n()};return t.prototype=Object.create(DbProxy.prototype),t.prototype.getRecords=function(t,n){var o="object"==typeof t?t:{key:t},r=e(o.key);o.sort&&r.orderBy(o.sort),"function"==typeof n&&n(r)},t.prototype.query=function(t,n,o){var r=e(t),i=r.query(n);o(i)},t.prototype.groupBy=function(t,n,o,r,i){var a=e(t);i(a.groupBy(o,r,n))},t.prototype.save=function(t,o,r){var i=e(t),a=i.indexOfKey("id",o.id);-1===a?i.push(o):i.splice(a,1,o),n(t,i,r)},t.prototype.remove=function(t,o,r){var i="object"==typeof o?o.id:o,a=e(t),c=a.indexOfKey("id",i);a.splice(c,1),n(t,a,r)},t.prototype.commit=function(t,e,n,o,r){function i(){s--,0===s&&u()}var a,c=this,f=e.concat(n),s=f.length+o.length,u=r&&"function"==typeof r?r:function(){};for(a=0;a<f.length;a++)c.save(t,f[a],i);for(a=0;a<o.length;a++)c.remove(t,o[a],i)},t}(),SQLiteProxy=function(){function t(t){var e;e=window.cordova&&window.sqlitePlugin?window.sqlitePlugin.openDatabase({name:t}):window.openDatabase(t,"SQLite Database","1.0",5242880),this.getDb=function(){return e},DbProxy.apply(this,arguments)}var e=new HashMap,n="SELECT * FROM";t.prototype=Object.create(DbProxy.prototype),t.prototype.getFields=function(t){var n=e.indexOfKey("table",t);return e[n].fields},t.prototype.createDatabase=function(t,n){e.length=0,e.putRange(t),this.getDb().transaction(function(e){function o(){u--,0===u&&s()}var r,i,a,c,f,s=n&&"function"==typeof n?n:function(){},u=t.length,p="";for(c=0;c<t.length;c++){for(i=t[c].table,f=0;f<t[c].fields.length;f++)r=t[c].fields[f],p+=[r.name,r.type,r.nullable?"":"NOT NULL",r.primary?"PRIMARY KEY":"",","].join(" ");p=p.substr(0,p.length-1),a=["CREATE TABLE IF NOT EXISTS",i,"(",p,")"].join(" "),e.executeSql(a,[],o)}})};var o=function(t,e,n,o,r){var i,a,c,f,s=self.getFields(t),u=s.map(function(t){return t.name}),p=new HashMap;o.executeSql(e,n,function(t,e){for(i=0;i<e.rows.length;i++){a=e.rows.item(i);for(c in a)f=u.indexOf(c),s[f].serialize&&(a[c]=JSON.parse(a[c]));p.push(a)}"function"==typeof r&&r(p)})},r=function(t){var e,n=[];for(e in t)n.push(e+t[e]);return"ORDER BY "+n.join(",")};t.prototype.getRecords=function(t,e){var i=t&&t.key?t.key:t,a=t&&t.sort?r(t.sort):"",c="object"==typeof t?[n,t.key,a,"LIMIT",t.limit].join(" "):[n,t].join(" ");this.getDb().transaction(function(t){o(i,c,[],t,e)})};var i=function(t,e){var n="";for(field in e)for(prop in e[field])switch(prop){case"$gt":n+=[field,">",e[field][prop]].join(" ");break;case"$gte":n+=[field,">=",e[field][prop]].join(" ");break;case"$lt":n+=[field,"<",e[field][prop]].join(" ");break;case"$lte":n+=[field,"<=",e[field][prop]].join(" ");break;case"$start":n+=[field," LIKE '",e[field][prop],"%'"].join("");break;case"$end":n+=[field," LIKE '%",e[field][prop],"'"].join("");break;case"$contain":n+=[field," LIKE '%",e[field][prop],"%'"].join("");break;case"$in":n+=[field," IN (",e[field][prop].join(","),")"].join("");break;case"$custom":n+=e[field][prop].call(e[field][prop],field);break;default:n+=""}return""===n?t:[t,"WHERE",n].join(" ")};return t.prototype.query=function(t,e,r){var a=e&&"object"==typeof e?e:{},c=[n,t].join(" "),f=i(c,a);this.getDb().transaction(function(e){o(t,f,[],e,r)})},t.prototype.insert=function(t,e,n,o){var r,i,a,c=[],f="",s="";for(i in e)a=e[i],"object"==typeof a&&(a=JSON.stringify(a)),c.push(a),f+=i+",",s+="?,";f=f.substr(0,f.length-1),s=s.substr(0,s.length-1),r=["INSERT INTO",t,"(",f,") VALUES (",s,")"].join(" "),n.executeSql(r,c,o)},t.prototype.update=function(t,e,n,o){var r,i,a,c=[],f="id = "+e.id,s="";for(i in e)"id"!=i&&(a=e[i],"object"==typeof a&&(a=JSON.stringify(a)),c.push(a),s+=i+" = ?,");s=s.substr(0,s.length-1),r=["UPDATE",t,"set",s,"WHERE",f].join(" "),n.executeSql(r,c,o)},t.prototype["delete"]=function(t,e,n,o){var r,i="object"==typeof e?e.id:e,a="id = "+i;r=["DELETE FROM",t,"WHERE",a].join(" "),n.executeSql(r,[],o)},t.prototype.commit=function(t,e,n,o,r){function i(){return f--,0===f?void s():void 0}var a,c=this,f=e.length+n.length+o.length,s=r&&"function"==typeof r?r:function(){};c.getDb().transaction(function(r){for(a=0;a<e.length;a++)c.insert(t,e[a],r,i);for(a=0;a<n.length;a++)c.update(t,n[a],r,i);for(a=0;a<o.length;a++)c["delete"](t,o[a],r,i)})},t}(),SyncDb=function(){function t(){}var e={Insert:"_inserted",Update:"_updated",Delete:"_deleted"},n=function(t,e){return["sync_",e,t].join("")},o=function(t,e,o){var r=n(t,e);window.localStorage[r]=JSON.stringify(o)},r=function(t,e){var o=n(t,e),r=window.localStorage[o],i=new HashMap;return r&&i.putRange(JSON.parse(r)),i};return t.prototype.writeData=function(t,n,i,a){var c=r(e.Insert,t),f=r(e.Update,t),s=r(e.Delete,t);c.putRange(n,!0),f.putRange(i,!0),s.putRange(a,!0),o(e.Insert,t,c),o(e.Update,t,f),o(e.Delete,t,s)},t.prototype.cleanData=function(t){o(e.Insert,t,[]),o(e.Update,t,[]),o(e.Delete,t,[])},t.prototype.sendData=function(t,e,n,o,r){"function"==typeof r&&r()},t.prototype.getNews=function(t,e){"function"==typeof e&&e([])},t.prototype.exec=function(t,n){var o=this,i=n||function(){};o.sendData(t,r(e.Insert,t),r(e.Update,t),r(e.Delete,t),function(){o.cleanData(t),o.getNews(t,i)})},t}(),DataSet=function(){function t(t,e,n){var o=[],r=[],i=[],a=t,c=e,f=n;this.active=!1,this.limit=1e3,this.sort=null,this.data=new HashMap,this.getInserteds=function(){return o},this.getUpdateds=function(){return r},this.getDeleteds=function(){return i},this.getProxy=function(){return a},this.getTable=function(){return c},this.getSyncronizer=function(){return f}}var e=function(t){var e=t.getInserteds(),n=t.getUpdateds(),o=t.getDeleteds();e.length=0,n.length=0,o.length=0};return t.prototype.open=function(t){function e(t,e){"function"==typeof e&&e(t)}var n=this,o={key:n.getTable(),limit:n.limit,sort:n.sort};return n.active?void e(n.data,t):void n.getProxy().getRecords(o,function(o){n.data=o,n.active=!0,e(o,t)})},t.prototype.close=function(){var t=this;t.active=!1,t.data.length=0,e(t)},t.prototype.getById=function(t){var e=this.data.indexOfKey("id",parseInt(t));return this.data[e]},t.prototype.refresh=function(){var t=this;t.sort&&t.data.orderBy(t.sort)},t.prototype.insert=function(t){if(!this.active)throw"Invalid operation on closed dataset";t&&!t.id&&(t.id=(new Date).getTime());var e=this.getInserteds(),n=this.data.indexOfKey("id",t.id);-1===n&&(e.push(t),this.data.push(t))},t.prototype.update=function(t){if(!this.active)throw"Invalid operation on closed dataset";var e=this.getUpdateds(),n=this.data.indexOfKey("id",t.id);e[n]?e.splice(n,1,t):e.push(t),this.data.splice(n,1,t)},t.prototype.save=function(t){t&&!t.id?this.insert(t):this.update(t)},t.prototype["delete"]=function(t){if(!this.active)throw"Invalid operation on closed dataset";var e=this.getDeleteds(),n=this.data.indexOfKey("id",t.id);e[n]||e.push(t),this.data.splice(n,1)},t.prototype.post=function(t){function n(){r&&r.writeData(o.getTable(),i,a,c),e(o),"function"==typeof t&&t()}if(!this.active)throw"Invalid operation on closed dataset";var o=this,t=t,r=this.getSyncronizer(),i=this.getInserteds(),a=this.getUpdateds(),c=this.getDeleteds();return i.length||a.length||c.length?void o.getProxy().commit(this.getTable(),i,a,c,n):void("function"==typeof t&&t())},t.prototype.sync=function(t){var e=this,n=this.getSyncronizer();n&&n.exec(e.getTable(),function(n){n.forEach(function(t){e.data.indexOfKey("id",t.id)<0&&e.insert(t)}),e.data.post(),e.refresh(),"function"==typeof t&&t()})},t.prototype.filter=function(t){return t&&"function"==typeof t?this.data.filter(t):this.data.query(t)},t}(),DbFactory=function(){function t(t,e,n){var o,r=n;if(this.getProxy=function(){return o},this.getSyncronizer=function(){return r},e&&"object"==typeof e)return void(o=e);switch(e){case 0:o=new LocalStorageProxy;break;case 1:o=new SQLiteProxy(t);break;default:throw"Proxy not implemented"}}return t.prototype.createDatabase=function(t,e){this.getProxy().createDatabase(t,e)},t.prototype.query=function(t,e,n){this.getProxy().query(t,e,n)},t.prototype.groupBy=function(t,e,n,o,r){this.getProxy().groupBy(t,e,n,o,r)},t.prototype.createDataSet=function(t){return new DataSet(this.getProxy(),t,this.getSyncronizer())},t}();