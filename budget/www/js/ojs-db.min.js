var HashMap=function(){function t(){var e=[];return e=Array.apply(e,arguments)||e,e.__proto__=t.prototype,e.mapTable=function(t){return this.map(function(e){return e[t]})},e.indexOfKey=function(t,e){return this.mapTable(t).indexOf(e)},e.put=function(t,e){var o=e||this.length;this[o]=t},e.putRange=function(t){for(var e=0;e<t.length;e++)this.put(t[e],e)},e}return t.prototype=Object.create(Array.prototype),t}(),DbProxies=function(){return{LOCALSTORAGE:0,SQLITE:1}}(),DbProxy=function(){function t(){this.createDatabase=function(){}}return t}(),LocalStorageProxy=function(){function t(){DbProxy.apply(this,arguments)}var e=function(t){var e=window.localStorage[t],o=new HashMap;return e&&o.putRange(JSON.parse(e)),o},o=function(t,e,o){window.localStorage[t]=JSON.stringify(e),"function"==typeof o&&o()};return t.prototype=Object.create(DbProxy.prototype),t.prototype.getRecords=function(t,o){var n="object"==typeof t?t:{key:t},r=e(n.key);n.sort&&""!==n.sort&&r.sort(function(t,e){return(t[n.sort]>e[n.sort])-(t[n.sort]<e[n.sort])}),"function"==typeof o&&o(r)},t.prototype.select=function(t,o,n){var r,i,a,s,c=e(t),o=o&&"object"==typeof o?o:{},f=[];for(a=0;a<c.length;a++){r=!0,i=c[a];for(s in o)if(i[s]!=o[s]){r=!1;break}r&&f.push(i)}n(f)},t.prototype.save=function(t,n,r){var i=e(t),a=i.indexOfKey("id",n.id);-1===a?i.push(n):i.splice(a,1,n),o(t,i,r)},t.prototype.remove=function(t,n,r){var i="object"==typeof n?n.id:n,a=e(t),s=a.indexOfKey("id",i);a.splice(s,1),o(t,a,r)},t.prototype.commit=function(t,e,o,n,r){function i(){f--,0===f&&u()}var a,s=this,c=e.concat(o),f=c.length+n.length,u=r&&"function"==typeof r?r:function(){};for(a=0;a<c.length;a++)s.save(t,c[a],i);for(a=0;a<n.length;a++)s.remove(t,n[a],i)},t}(),SQLiteProxy=function(){function t(t){var e;e=window.cordova&&window.sqlitePlugin?window.sqlitePlugin.openDatabase({name:t}):window.openDatabase(t,"SQLite Database","1.0",5242880),this.getDb=function(){return e},DbProxy.apply(this,arguments)}var e=new HashMap;t.prototype=Object.create(DbProxy.prototype),t.prototype.getFields=function(t){var o=e.indexOfKey("table",t);return e[o].fields},t.prototype.createDatabase=function(t,o){e.length=0,e.putRange(t),this.getDb().transaction(function(e){function n(){u--,0===u&&f()}var r,i,a,s,c,f=o&&"function"==typeof o?o:function(){},u=t.length,p="";for(s=0;s<t.length;s++){for(i=t[s].table,c=0;c<t[s].fields.length;c++)r=t[s].fields[c],p+=[r.name,r.type,r.nullable?"":"NOT NULL",r.primary?"PRIMARY KEY":"",","].join(" ");p=p.substr(0,p.length-1),a=["CREATE TABLE IF NOT EXISTS",i,"(",p,")"].join(" "),e.executeSql(a,[],n)}})};var o=function(t,e,o){var n,r,i,a,s=["SELECT * FROM",t.key,t.sort,"LIMIT",t.limit].join(" "),c=self.getFields(t.key),f=c.map(function(t){return t.name}),u=new HashMap;e.executeSql(s,t.params,function(t,e){for(n=0;n<e.rows.length;n++){r=e.rows.item(n);for(i in r)a=f.indexOf(i),c[a].serialize&&(r[i]=JSON.parse(r[i]));u.push(r)}"function"==typeof o&&o(u)})};return t.prototype.getRecords=function(t,e){var n="object"==typeof t?t:{key:t,limit:1e3},r=n.sort&&""!==n.sort?"ORDER BY "+n.sort:"";n.sort=r,n.params=n.params||[],this.getDb().transaction(function(t){o(n,t,e)})},t.prototype.insert=function(t,e,o,n){var r,i,a,s=[],c="",f="";for(i in e)a=e[i],"object"==typeof a&&(a=JSON.stringify(a)),s.push(a),c+=i+",",f+="?,";c=c.substr(0,c.length-1),f=f.substr(0,f.length-1),r=["INSERT INTO",t,"(",c,") VALUES (",f,")"].join(" "),o.executeSql(r,s,n)},t.prototype.update=function(t,e,o,n){var r,i,a,s=[],c="id = "+e.id,f="";for(i in e)"id"!=i&&(a=e[i],"object"==typeof a&&(a=JSON.stringify(a)),s.push(a),f+=i+" = ?,");f=f.substr(0,f.length-1),r=["UPDATE",t,"set",f,"WHERE",c].join(" "),o.executeSql(r,s,n)},t.prototype["delete"]=function(t,e,o,n){var r,i="object"==typeof e?e.id:e,a="id = "+i;r=["DELETE FROM",t,"WHERE",a].join(" "),o.executeSql(r,[],n)},t.prototype.commit=function(t,e,o,n,r){function i(){return c--,0===c?void f():void 0}var a,s=this,c=e.length+o.length+n.length,f=r&&"function"==typeof r?r:function(){};s.getDb().transaction(function(r){for(a=0;a<e.length;a++)s.insert(t,e[a],r,i);for(a=0;a<o.length;a++)s.update(t,o[a],r,i);for(a=0;a<n.length;a++)s["delete"](t,n[a],r,i)})},t}(),DataSet=function(){function t(t,e){var o=t,n=e;this.active=!1,this.limit=1e3,this.sortBy="",this.data=new HashMap,this.getProxy=function(){return o},this.getTable=function(){return n}}var e=[],o=[],n=[],r=function(){e.length=0,n.length=0,o.length=0};return t.prototype.open=function(t){function e(t,e){"function"==typeof e&&e(t)}var o=this,n={key:o.getTable(),limit:o.limit,sort:o.sortBy};return o.active?void e(o.data,t):void o.getProxy().getRecords(n,function(n){o.data=n,o.active=!0,e(n,t)})},t.prototype.close=function(){this.active=!1,this.data.length=0,r()},t.prototype.getById=function(t){var e=this.data.indexOfKey("id",parseInt(t));return this.data[e]},t.prototype.refresh=function(){var t=this;""!==t.sortBy&&t.data.sort(function(e,o){return(e[t.sortBy]>o[t.sortBy])-(e[t.sortBy]<o[t.sortBy])})},t.prototype.insert=function(t){if(!this.active)throw"Invalid operation on closed dataset";t&&!t.id&&(t.id=(new Date).getTime());var o=this.data.indexOfKey("id",t.id);-1===o&&(e.push(t),this.data.push(t))},t.prototype.update=function(t){if(!this.active)throw"Invalid operation on closed dataset";var e=this.data.indexOfKey("id",t.id);n[e]?n.splice(e,1,t):n.push(t),this.data.splice(e,1,t)},t.prototype["delete"]=function(t){if(!this.active)throw"Invalid operation on closed dataset";var e=this.data.indexOfKey("id",t.id);o[e]||o.push(t),this.data.splice(e,1)},t.prototype.post=function(t){function i(){r(),"function"==typeof t&&t()}if(!this.active)throw"Invalid operation on closed dataset";var a=this,t=t;a.getProxy().commit(this.getTable(),e,n,o,i)},t.prototype.filter=function(t){return t&&"function"==typeof t?this.data.filter(t):this.data.filter(function(e){var o,n=!0;for(o in t)if(e[o]!=t[o]){n=!1;break}return n})},t.prototype.cloneObject=function(t){if("[object Array]"===Object.prototype.toString.call(t)){for(var e=[],o=0,n=t.length;n>o;o++)e[o]=arguments.callee(t[o]);return e}if(t&&!(t instanceof Date)&&"object"==typeof t){var o,e={};for(o in t)e[o]=arguments.callee(t[o]);return e}return t},t}(),DbFactory=function(){function t(t,n){switch(o=t,n){case 0:e=new LocalStorageProxy;break;case 1:e=new SQLiteProxy(t);break;default:throw"Proxy not implemented"}}var e,o;return t.prototype.getProxy=function(){return e},t.prototype.createDatabase=function(t,e){this.getProxy().createDatabase(t,e)},t.prototype.createDataSet=function(t){return new DataSet(this.getProxy(),t)},t.prototype.select=function(t,e,o){this.getProxy().select(t,e,o)},t}();