function HashMap(){var t=[];return t=Array.apply(t,arguments)||t,t.__proto__=HashMap.prototype,t.mapTable=function(t){return this.map(function(e){return e[t]})},t.indexOfKey=function(t,e){return this.mapTable(t).indexOf(e)},t.put=function(t,e){var o=e||this.length;this[o]=t},t.putRange=function(t){for(var e=0;e<t.length;e++)this.put(t[e],e)},t}function DbProxy(){this.createDatabase=function(){}}function LocalStorageProxy(){}function SQLiteProxy(t){var e;e=window.cordova&&window.sqlitePlugin?window.sqlitePlugin.openDatabase({name:t}):window.openDatabase(t,"SQLite Database","1.0",5242880),this._maps=new HashMap,this.getDb=function(){return e}}function DataSet(t,e){var o=t,i=e;this._inserteds=[],this._deleteds=[],this._updateds=[],this.active=!1,this.limit=1e3,this.sortBy="",this.data=new HashMap,this.getProxy=function(){return o},this.getTable=function(){return i}}function DbFactory(t,e){var o;switch(e){case 0:o=new LocalStorageProxy;break;case 1:o=new SQLiteProxy(t);break;default:throw"Proxy not implemented"}this.opts=t,this.getProxy=function(){return o}}DbProxies={LOCALSTORAGE:0,SQLITE:1},HashMap.prototype=new Array,LocalStorageProxy.prototype=new DbProxy,LocalStorageProxy.prototype.constructor=LocalStorageProxy,LocalStorageProxy.prototype._get=function(t){var e=window.localStorage[t],o=new HashMap;return e&&o.putRange(JSON.parse(e)),o},LocalStorageProxy.prototype.getRecords=function(t,e){var o="object"==typeof t?t:{key:t},i=this._get(o.key);o.sort&&""!==o.sort&&i.sort(function(t,e){return(t[o.sort]>e[o.sort])-(t[o.sort]<e[o.sort])}),"function"==typeof e&&e(i)},LocalStorageProxy.prototype.select=function(t,e,o){var i,n,r,a,s=this._get(t),e=e&&"object"==typeof e?e:{},c=[];for(r=0;r<s.length;r++){i=!0,n=s[r];for(a in e)if(n[a]!=e[a]){i=!1;break}i&&c.push(n)}o(c)},LocalStorageProxy.prototype._saveAll=function(t,e,o){window.localStorage[t]=JSON.stringify(e),"function"==typeof o&&o()},LocalStorageProxy.prototype.save=function(t,e,o){var i=this._get(t),n=i.indexOfKey("id",e.id);-1===n?i.push(e):i.splice(n,1,e),this._saveAll(t,i,o)},LocalStorageProxy.prototype.remove=function(t,e,o){var i="object"==typeof e?e.id:e,n=this._get(t),r=n.indexOfKey("id",i);n.splice(r,1),this._saveAll(t,n,o)},LocalStorageProxy.prototype.commit=function(t,e,o,i,n){function r(){p--,0===p&&f()}var a,s=this,c=e.concat(o),p=c.length+i.length,f=n&&"function"==typeof n?n:function(){};for(a=0;a<c.length;a++)s.save(t,c[a],r);for(a=0;a<i.length;a++)s.remove(t,i[a],r)},SQLiteProxy.prototype=new DbProxy,SQLiteProxy.prototype.constructor=SQLiteProxy,SQLiteProxy.prototype.getFields=function(t){var e=this._maps.indexOfKey("table",t);return this._maps[e].fields},SQLiteProxy.prototype.createDatabase=function(t,e){this._maps.length=0,this._maps.putRange(t),this.getDb().transaction(function(o){function i(){f--,0===f&&p()}var n,r,a,s,c,p=e&&"function"==typeof e?e:function(){},f=t.length,u="";for(s=0;s<t.length;s++){for(r=t[s].table,c=0;c<t[s].fields.length;c++)n=t[s].fields[c],u+=[n.name,n.type,n.nullable?"":"NOT NULL",n.primary?"PRIMARY KEY":"",","].join(" ");u=u.substr(0,u.length-1),a=["CREATE TABLE IF NOT EXISTS",r,"(",u,")"].join(" "),o.executeSql(a,[],i)}})},SQLiteProxy.prototype.getRecords=function(t,e){var o="object"==typeof t?t:{key:t,limit:1e3},i=o.sort&&""!==o.sort?"ORDER BY "+o.sort:"",n=this;n.getDb().transaction(function(t){var r,a,s,c,p=["SELECT * FROM",o.key,i,"LIMIT",o.limit].join(" "),f=n.getFields(o.key),u=f.map(function(t){return t.name}),h=new HashMap;t.executeSql(p,[],function(t,o){for(r=0;r<o.rows.length;r++){a=o.rows.item(r);for(s in a)c=u.indexOf(s),f[c].serialize&&(a[s]=JSON.parse(a[s]));h.push(a)}"function"==typeof e&&e(h)})})},SQLiteProxy.prototype.insert=function(t,e,o,i){var n,r,a,s=[],c="",p="";for(r in e)a=e[r],"object"==typeof a&&(a=JSON.stringify(a)),s.push(a),c+=r+",",p+="?,";c=c.substr(0,c.length-1),p=p.substr(0,p.length-1),n=["INSERT INTO",t,"(",c,") VALUES (",p,")"].join(" "),o.executeSql(n,s,i)},SQLiteProxy.prototype.update=function(t,e,o,i){var n,r,a,s=[],c="id = "+e.id,p="";for(r in e)"id"!=r&&(a=e[r],"object"==typeof a&&(a=JSON.stringify(a)),s.push(a),p+=r+" = ?,");p=p.substr(0,p.length-1),n=["UPDATE",t,"set",p,"WHERE",c].join(" "),o.executeSql(n,s,i)},SQLiteProxy.prototype["delete"]=function(t,e,o,i){var n,r="object"==typeof e?e.id:e,a="id = "+r;n=["DELETE FROM",t,"WHERE",a].join(" "),o.executeSql(n,[],i)},SQLiteProxy.prototype.commit=function(t,e,o,i,n){function r(){return c--,0===c?void p():void 0}var a,s=this,c=e.length+o.length+i.length,p=n&&"function"==typeof n?n:function(){};s.getDb().transaction(function(n){for(a=0;a<e.length;a++)s.insert(t,e[a],n,r);for(a=0;a<o.length;a++)s.update(t,o[a],n,r);for(a=0;a<i.length;a++)s["delete"](t,i[a],n,r)})},DataSet.prototype.open=function(t){function e(t,e){"function"==typeof e&&e(t)}var o=this,i={key:o.getTable(),limit:o.limit,sort:o.sortBy};return o.active?void e(o.data,t):void o.getProxy().getRecords(i,function(i){o.data=i,o.active=!0,e(i,t)})},DataSet.prototype._cleanCache=function(){this._inserteds.length=0,this._updateds.length=0,this._deleteds.length=0},DataSet.prototype.close=function(){this.active=!1,this.data.length=0,this._cleanCache()},DataSet.prototype.getById=function(t){var e=this.data.indexOfKey("id",parseInt(t));return this.data[e]},DataSet.prototype.refresh=function(){var t=this;""!==t.sortBy&&this.data.sort(function(e,o){return(e[t.sortBy]>o[t.sortBy])-(e[t.sortBy]<o[t.sortBy])})},DataSet.prototype.insert=function(t){if(!this.active)throw"Invalid operation on closed dataset";t&&!t.id&&(t.id=(new Date).getTime());var e=this.data.indexOfKey("id",t.id);-1===e&&(this._inserteds.push(t),this.data.push(t))},DataSet.prototype.update=function(t){if(!this.active)throw"Invalid operation on closed dataset";var e=this.data.indexOfKey("id",t.id);this._updateds[e]?this._updateds.splice(e,1,t):this._updateds.push(t),this.data.splice(e,1,t)},DataSet.prototype["delete"]=function(t){if(!this.active)throw"Invalid operation on closed dataset";var e=this.data.indexOfKey("id",t.id);this._deleteds[e]||this._deleteds.push(t),this.data.splice(e,1)},DataSet.prototype.post=function(t){function e(){o._cleanCache(),"function"==typeof t&&t()}if(!this.active)throw"Invalid operation on closed dataset";var o=this,t=t;this.getProxy().commit(this.getTable(),this._inserteds,this._updateds,this._deleteds,e)},DataSet.prototype.filter=function(t){return t&&"function"==typeof t?this.data.filter(t):this.data.filter(function(e){var o,i=!0;for(o in t)if(e[o]!=t[o]){i=!1;break}return i})},DbFactory.prototype.createDatabase=function(t,e){this.getProxy().createDatabase(t,e)},DbFactory.prototype.createDataSet=function(t){return new DataSet(this.getProxy(),t)},DbFactory.prototype.select=function(t,e,o){this.getProxy().select(t,e,o)};