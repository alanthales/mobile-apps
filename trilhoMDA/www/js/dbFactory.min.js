var HashMap=function(){function t(){var e=[];return e=Array.apply(e,arguments)||e,e.__proto__=t.prototype,e.mapTable=function(t){return this.map(function(e){return e[t]})},e.indexOfKey=function(t,e){return this.mapTable(t).indexOf(e)},e.put=function(t,e){var n=e||this.length;this[n]=t},e.putRange=function(t){for(var e=0;e<t.length;e++)this.put(t[e],e)},e}return t.prototype=new Array,t}(),DbProxies=function(){return{LOCALSTORAGE:0,SQLITE:1}}(),DbProxy=function(){function t(){this.createDatabase=function(){}}return t}(),LocalStorageProxy=function(){function t(){DbProxy.apply(this,arguments)}var e=function(t){var e=window.localStorage[t],n=new HashMap;return e&&n.putRange(JSON.parse(e)),n},n=function(t,e,n){window.localStorage[t]=JSON.stringify(e),"function"==typeof n&&n()};return t.prototype=Object.create(DbProxy.prototype),t.prototype.getRecords=function(t,n){var o="object"==typeof t?t:{key:t},i=e(o.key);o.sort&&""!==o.sort&&i.sort(function(t,e){return(t[o.sort]>e[o.sort])-(t[o.sort]<e[o.sort])}),"function"==typeof n&&n(i)},t.prototype.select=function(t,n,o){var i,r,a,s,c=e(t),n=n&&"object"==typeof n?n:{},u=[];for(a=0;a<c.length;a++){i=!0,r=c[a];for(s in n)if(r[s]!=n[s]){i=!1;break}i&&u.push(r)}o(u)},t.prototype.save=function(t,o,i){var r=e(t),a=r.indexOfKey("id",o.id);-1===a?r.push(o):r.splice(a,1,o),n(t,r,i)},t.prototype.remove=function(t,o,i){var r="object"==typeof o?o.id:o,a=e(t),s=a.indexOfKey("id",r);a.splice(s,1),n(t,a,i)},t.prototype.commit=function(t,e,n,o,i){function r(){u--,0===u&&f()}var a,s=this,c=e.concat(n),u=c.length+o.length,f=i&&"function"==typeof i?i:function(){};for(a=0;a<c.length;a++)s.save(t,c[a],r);for(a=0;a<o.length;a++)s.remove(t,o[a],r)},t}(),SQLiteProxy=function(){function t(t){var e;e=window.cordova&&window.sqlitePlugin?window.sqlitePlugin.openDatabase({name:t}):window.openDatabase(t,"SQLite Database","1.0",5242880),this.getDb=function(){return e},DbProxy.apply(this,arguments)}var e=new HashMap;return t.prototype=Object.create(DbProxy.prototype),t.prototype.getFields=function(t){var n=e.indexOfKey("table",t);return e[n].fields},t.prototype.createDatabase=function(t,n){e.length=0,e.putRange(t),this.getDb().transaction(function(e){function o(){f--,0===f&&u()}var i,r,a,s,c,u=n&&"function"==typeof n?n:function(){},f=t.length,p="";for(s=0;s<t.length;s++){for(r=t[s].table,c=0;c<t[s].fields.length;c++)i=t[s].fields[c],p+=[i.name,i.type,i.nullable?"":"NOT NULL",i.primary?"PRIMARY KEY":"",","].join(" ");p=p.substr(0,p.length-1),a=["CREATE TABLE IF NOT EXISTS",r,"(",p,")"].join(" "),e.executeSql(a,[],o)}})},t.prototype.getRecords=function(t,e){var n="object"==typeof t?t:{key:t,limit:1e3},o=n.sort&&""!==n.sort?"ORDER BY "+n.sort:"",i=this;i.getDb().transaction(function(t){var r,a,s,c,u=["SELECT * FROM",n.key,o,"LIMIT",n.limit].join(" "),f=i.getFields(n.key),p=f.map(function(t){return t.name}),y=new HashMap;t.executeSql(u,[],function(t,n){for(r=0;r<n.rows.length;r++){a=n.rows.item(r);for(s in a)c=p.indexOf(s),f[c].serialize&&(a[s]=JSON.parse(a[s]));y.push(a)}"function"==typeof e&&e(y)})})},t.prototype.insert=function(t,e,n,o){var i,r,a,s=[],c="",u="";for(r in e)a=e[r],"object"==typeof a&&(a=JSON.stringify(a)),s.push(a),c+=r+",",u+="?,";c=c.substr(0,c.length-1),u=u.substr(0,u.length-1),i=["INSERT INTO",t,"(",c,") VALUES (",u,")"].join(" "),n.executeSql(i,s,o)},t.prototype.update=function(t,e,n,o){var i,r,a,s=[],c="id = "+e.id,u="";for(r in e)"id"!=r&&(a=e[r],"object"==typeof a&&(a=JSON.stringify(a)),s.push(a),u+=r+" = ?,");u=u.substr(0,u.length-1),i=["UPDATE",t,"set",u,"WHERE",c].join(" "),n.executeSql(i,s,o)},t.prototype["delete"]=function(t,e,n,o){var i,r="object"==typeof e?e.id:e,a="id = "+r;i=["DELETE FROM",t,"WHERE",a].join(" "),n.executeSql(i,[],o)},t.prototype.commit=function(t,e,n,o,i){function r(){return c--,0===c?void u():void 0}var a,s=this,c=e.length+n.length+o.length,u=i&&"function"==typeof i?i:function(){};s.getDb().transaction(function(i){for(a=0;a<e.length;a++)s.insert(t,e[a],i,r);for(a=0;a<n.length;a++)s.update(t,n[a],i,r);for(a=0;a<o.length;a++)s["delete"](t,o[a],i,r)})},t}(),DataSet=function(){function t(t,e){var n=t,o=e;this.active=!1,this.limit=1e3,this.sortBy="",this.data=new HashMap,this.getProxy=function(){return n},this.getTable=function(){return o}}var e=[],n=[],o=[],i=function(){e.length=0,o.length=0,n.length=0};return t.prototype.open=function(t){function e(t,e){"function"==typeof e&&e(t)}var n=this,o={key:n.getTable(),limit:n.limit,sort:n.sortBy};return n.active?void e(n.data,t):void n.getProxy().getRecords(o,function(o){n.data=o,n.active=!0,e(o,t)})},t.prototype.close=function(){this.active=!1,this.data.length=0,i()},t.prototype.getById=function(t){var e=this.data.indexOfKey("id",parseInt(t));return this.data[e]},t.prototype.refresh=function(){var t=this;""!==t.sortBy&&t.data.sort(function(e,n){return(e[t.sortBy]>n[t.sortBy])-(e[t.sortBy]<n[t.sortBy])})},t.prototype.insert=function(t){if(!this.active)throw"Invalid operation on closed dataset";t&&!t.id&&(t.id=(new Date).getTime());var n=this.data.indexOfKey("id",t.id);-1===n&&(e.push(t),this.data.push(t))},t.prototype.update=function(t){if(!this.active)throw"Invalid operation on closed dataset";var e=this.data.indexOfKey("id",t.id);o[e]?o.splice(e,1,t):o.push(t),this.data.splice(e,1,t)},t.prototype["delete"]=function(t){if(!this.active)throw"Invalid operation on closed dataset";var e=this.data.indexOfKey("id",t.id);n[e]||n.push(t),this.data.splice(e,1)},t.prototype.post=function(t){function r(){i(),"function"==typeof t&&t()}if(!this.active)throw"Invalid operation on closed dataset";var a=this,t=t;a.getProxy().commit(this.getTable(),e,o,n,r)},t.prototype.filter=function(t){return t&&"function"==typeof t?this.data.filter(t):this.data.filter(function(e){var n,o=!0;for(n in t)if(e[n]!=t[n]){o=!1;break}return o})},t}(),DbFactory=function(){function t(t,o){switch(n=t,o){case 0:e=new LocalStorageProxy;break;case 1:e=new SQLiteProxy(t);break;default:throw"Proxy not implemented"}}var e,n;return t.prototype.getProxy=function(){return e},t.prototype.createDatabase=function(t,e){this.getProxy().createDatabase(t,e)},t.prototype.createDataSet=function(t){return new DataSet(this.getProxy(),t)},t.prototype.select=function(t,e,n){this.getProxy().select(t,e,n)},t}();